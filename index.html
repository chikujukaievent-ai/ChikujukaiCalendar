<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: #f4f4f4;
      position: sticky;
      top: 0;
    }

    .has-event {
      background-color: #ffebee;
    }

    .date-column {
      width: 18%;
      white-space: nowrap;
    }

    .time-label {
      font-size: 0.85em;
      color: #d32f2f;
      font-weight: bold;
      display: block;
    }

    .location-label {
      font-size: 0.8em;
      color: #1976d2;
      display: inline-block;
      margin-top: 2px;
    }

    .location-label:hover {
      color: #0d47a1;
    }

    .event-item {
      margin-bottom: 4px;
      border-bottom: 1px dashed #eee;
      padding-bottom: 2px;
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .sun {
      color: red;
    }

    .sat {
      color: blue;
    }

    .date-cell {
      cursor: pointer;
    }

    .date-cell:hover {
      background-color: #e3f2fd;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-menu {
      background: white;
      border-radius: 12px;
      padding: 16px;
      min-width: 280px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      text-align: center;
      color: #333;
    }

    .menu-btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-align: left;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .menu-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .menu-btn.both {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
    }

    .menu-btn.kawahigashi {
      background: linear-gradient(135deg, #FF9800, #F57C00);
      color: white;
    }

    .menu-btn.nagazumi {
      background: linear-gradient(135deg, #2196F3, #1565C0);
      color: white;
    }

    .menu-btn.cancel {
      background: #f5f5f5;
      color: #666;
      text-align: center;
    }

    .menu-btn .time-info {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 2px;
    }
  </style>
</head>

<body>
  <div id="content">èª­ã¿è¾¼ã¿ä¸­...</div>

  <!-- é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="modal-overlay" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-menu" onclick="event.stopPropagation()">
      <div class="modal-title" id="modal-date-title">äºˆå®šã‚’è¿½åŠ </div>
      <button class="menu-btn both" id="btn-both">
        ğŸ“… åŒæ—¥ï¼ˆå·æ± + é•·ç‚­ï¼‰
        <div class="time-info">åˆå‰ 9:30ã€œ ï¼† åˆå¾Œ 13:30ã€œ</div>
      </button>
      <button class="menu-btn kawahigashi" id="btn-kawahigashi">
        ğŸ  å·æ±ã®ã¿
        <div class="time-info">9:30ã€œ11:30 å·æ±ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚»ãƒ³ã‚¿ãƒ¼</div>
      </button>
      <button class="menu-btn nagazumi" id="btn-nagazumi">
        ğŸ›ï¸ é•·ç‚­ã®ã¿
        <div class="time-info">13:30ã€œ15:30 é•·ç‚­å…¬æ°‘é¤¨</div>
      </button>
      <button class="menu-btn cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <script>
    const GCAL_BASE = "https://calendar.google.com/calendar/u/0";
    let currentConfig = null;
    let selectedDate = null;

    function buildGCalUrl(dateObj, eventType, config) {
      const y = dateObj.getFullYear();
      const m = ("0" + (dateObj.getMonth() + 1)).slice(-2);
      const d = ("0" + dateObj.getDate()).slice(-2);

      const [startH, startMin] = eventType.startTime.split(":");
      const [endH, endMin] = eventType.endTime.split(":");
      const start = `${startH}${startMin}00`;
      const end = `${endH}${endMin}00`;

      const ctz = encodeURIComponent(config?.timezone || "Asia/Tokyo");
      const calendarId = config?.calendarId ? encodeURIComponent(config.calendarId) : "";
      const title = encodeURIComponent(eventType.title);

      // å ´æ‰€ã«Google Mapsãƒªãƒ³ã‚¯ã‚’å«ã‚ã‚‹
      const locationWithMap = eventType.location;
      const location = encodeURIComponent(locationWithMap);

      return `${GCAL_BASE}/r/eventedit?dates=${y}${m}${d}T${start}/${y}${m}${d}T${end}&ctz=${ctz}&text=${title}${calendarId ? `&src=${calendarId}` : ''}&location=${location}`;
    }

    function showModal(dateObj, config) {
      selectedDate = dateObj;
      currentConfig = config;

      const displayDate = (dateObj.getMonth() + 1) + '/' + dateObj.getDate();
      const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dateObj.getDay()];
      document.getElementById('modal-date-title').textContent = `${displayDate}(${dayOfWeek}) ã«äºˆå®šã‚’è¿½åŠ `;

      document.getElementById('modal-overlay').classList.add('show');
    }

    function closeModal(event) {
      if (!event || event.target === document.getElementById('modal-overlay')) {
        document.getElementById('modal-overlay').classList.remove('show');
      }
    }

    function handleEventChoice(choice) {
      if (!selectedDate || !currentConfig) return;

      const events = currentConfig.events;

      if (choice === 'both') {
        // ä¸¡æ–¹ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        window.open(buildGCalUrl(selectedDate, events.KAWAHIGASHI, currentConfig), '_blank');
        setTimeout(() => {
          window.open(buildGCalUrl(selectedDate, events.NAGAZUMI, currentConfig), '_blank');
        }, 300);
      } else if (choice === 'kawahigashi') {
        window.open(buildGCalUrl(selectedDate, events.KAWAHIGASHI, currentConfig), '_blank');
      } else if (choice === 'nagazumi') {
        window.open(buildGCalUrl(selectedDate, events.NAGAZUMI, currentConfig), '_blank');
      }

      closeModal();
    }

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.getElementById('btn-both').onclick = () => handleEventChoice('both');
    document.getElementById('btn-kawahigashi').onclick = () => handleEventChoice('kawahigashi');
    document.getElementById('btn-nagazumi').onclick = () => handleEventChoice('nagazumi');

    google.script.run.withSuccessHandler(function (data) {
      let html = '<table><tr><th class="date-column">æ—¥ä»˜</th><th>æ™‚é–“ãƒ»äºˆå®šãƒ»å ´æ‰€</th></tr>';
      let curr = new Date();

      for (let i = 0; i < 120; i++) {
        let dateStr = curr.getFullYear() + '-' +
          ('0' + (curr.getMonth() + 1)).slice(-2) + '-' +
          ('0' + curr.getDate()).slice(-2);

        let displayDate = (curr.getMonth() + 1) + '/' + curr.getDate();
        let dayIdx = curr.getDay();
        let dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dayIdx];
        let dayClass = dayIdx === 0 ? 'sun' : (dayIdx === 6 ? 'sat' : '');

        let events = data.schedule[dateStr] || [];
        let rowClass = events.length > 0 ? 'has-event' : '';

        // æ—¥ä»˜ç”¨ã®ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’è¿½åŠ 
        const dateData = curr.toISOString();

        let eventHtml = events.map(ev => {
          let locationHtml = '';
          if (ev.location) {
            let locationName = ev.location.replace('ğŸ“', '');
            let mapsUrl = "https://maps.google.com/?q=" + encodeURIComponent(locationName);
            locationHtml = '<a href="' + mapsUrl + '" target="_blank" class="location-label" style="text-decoration: underline;">' + ev.location + '</a>';
          }
          return `
          <div class="event-item">
            <span class="time-label">${ev.time}</span>
            <strong>${ev.title}</strong>
            ${locationHtml}
          </div>
        `;
        }).join('');

        html += `<tr class="${rowClass}">
          <td class="date-column date-cell ${dayClass}" data-date="${dateData}">${displayDate}(${dayOfWeek})</td>
          <td>${eventHtml}</td>
        </tr>`;
        curr.setDate(curr.getDate() + 1);
      }
      html += '</table>';
      document.getElementById('content').innerHTML = html;

      // æ—¥ä»˜ã‚»ãƒ«ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      document.querySelectorAll('.date-cell').forEach(cell => {
        cell.addEventListener('click', function () {
          const dateStr = this.getAttribute('data-date');
          const dateObj = new Date(dateStr);
          showModal(dateObj, data.config);
        });
      });
    }).withFailureHandler(function (error) {
      document.getElementById('content').innerHTML = '<div style="color:red;padding:20px;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
    }).getCalendarData();
  </script>
</body>

</html>